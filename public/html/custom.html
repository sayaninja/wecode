<!DOCTYPE html>
<html>
<head>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 10%;
            right: 0;
            bottom: 0;
            left: 0;
            height: 50%;
            width: 50%;
        }
    </style>
    <!-- Load the Realtime JavaScript library -->
    <script src="https://apis.google.com/js/api.js"></script>

    <!-- Load the utility library -->
    <script src="https://www.gstatic.com/realtime/realtime-client-utils.js"></script>
</head>
<body>
<main>

    <button id="auth_button">Authorize</button>
    <button id="auth">Hey</button>
    <div id="editor">function foo(items) {
        var x = "All this is syntax highlighted";
        return x;
        }</div>

</main>
<script src="https://cdn.jsdelivr.net/ace/1.2.0/min/ace.js" type="text/javascript" charset="utf-8"></script>

<script>
    var collaborativeString;
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/javascript");
    editor.getSession().setUseWrapMode(true);


    var clientId = '863094468582-16kemg10hk5ac7i4ud35lrkjd183o725.apps.googleusercontent.com';

    if (!/^([0-9])$/.test(clientId[0])) {
        alert('Invalid Client ID - did you forget to insert your application Client ID?');
    }
    // Create a new instance of the realtime utility with your client ID.
    var realtimeUtils = new utils.RealtimeUtils({ clientId: clientId });

    authorize();

    function authorize() {
        // Attempt to authorize
        realtimeUtils.authorize(function(response){
            if(response.error){
                // Authorization failed because this is the first time the user has used your application,
                // show the authorize button to prompt them to authorize manually.
                var button = document.getElementById('auth');
                button.classList.add('visible');
                button.addEventListener('click', function () {
                    realtimeUtils.authorize(function(response){
                        start();
                    }, true);
                });
            } else {
                start();
            }
        }, false);
    }

    function start() {
        // With auth taken care of, load a file, or create one if there
        // is not an id in the URL.
        var id = realtimeUtils.getParam('id');
        if (id) {
            // Load the document id from the URL
            realtimeUtils.load(id.replace('/', ''), onFileLoaded, onFileInitialize);
        } else {
            // Create a new document, add it to the URL
            realtimeUtils.createRealtimeFile('New Quickstart File', function(createResponse) {
                window.history.pushState(null, null, '?id=' + createResponse.id);
                realtimeUtils.load(createResponse.id, onFileLoaded, onFileInitialize);
            });
        }
    }

    // The first time a file is opened, it must be initialized with the
    // document structure. This function will add a collaborative string
    // to our model at the root.
    function onFileInitialize(model) {
        var string = model.createString();
        string.setText(editor.getValue());
        model.getRoot().set('demo_string', string);
    }

    // After a file has been initialized and loaded, we can access the
    // document. We will wire up the data model to the UI.
    function onFileLoaded(doc) {

        collaborativeString = doc.getModel().getRoot().get('demo_string');
        editor.setValue(collaborativeString.getText());
        wireCodeEditor(collaborativeString);
    }

    // Connects the code editor to the collaborative string
    function wireCodeEditor(inputString) {
        //var textArea1 = document.getElementById('text_area_1');
        console.log(inputString);
        collaborativeString.addEventListener(gapi.drive.realtime.EventType.TEXT_INSERTED, updateCodeEditorString);

    }

    var updateCodeEditorString = function(event ){
        if (!event.isLocal) {
            console.log('collaborativeString is changed');
            editor.getSession().getDocument().setValue(collaborativeString.getText());
        }
    }

    editor.getSession().on('change', function(e){
        console.log("editor text changed.");
        updateColabrativeString();
    });

    function updateColabrativeString() {
        collaborativeString.setText(editor.getSession().getDocument().getValue());
    }

</script>
</body>
</html>
